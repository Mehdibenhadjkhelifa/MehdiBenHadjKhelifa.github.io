<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/icon.png" type="image/png">
  <link rel="stylesheet" href=https://mehdibenhadjkhelifa.github.io/style.css?h=80d7be82f4db6ce043b9>
  <link rel="stylesheet" href=https://mehdibenhadjkhelifa.github.io/dark.css?h=0d9e8a03140eb52e643b
    media="screen and (prefers-color-scheme: dark)">
  <link rel="preload"
    href="/fonts/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.eot"
    as="font" crossorigin="anonymous" />
  <link rel="preload" href="/fonts/et-book/et-book-roman-line-figures/et-book-roman-line-figures.eot" as="font"
    crossorigin="anonymous" />
  <link rel="preload" href="/fonts/et-book/et-book-bold-line-figures/et-book-bold-line-figures.eot" as="font"
    crossorigin="anonymous" />
  <link rel="preload" href="/fonts/Fira_Sans/FiraSans-Regular.ttf" as="font" crossorigin="anonymous" />
  <link rel="preload" href="/fonts/Fira_Sans/FiraSans-Bold.ttf" as="font" crossorigin="anonymous" />
  <link rel="preload" href="/fonts/Fira_Sans/FiraSans-Italic.ttf" as="font" crossorigin="anonymous" />
  <link rel="preload" href="/fonts/Fira_Sans/FiraSans-BoldItalic.ttf" as="font" crossorigin="anonymous" />
  <link rel="stylesheet" type="text/css" href="/syntax-theme-dark.css" media="(prefers-color-scheme: dark)" />
  <link rel="stylesheet" type="text/css" href="/syntax-theme-light.css" media="(prefers-color-scheme: light)" />

  <title>How I solved a linux kernel memory leak bug \  ~Mehdi</title>
</head>

<body>
  <header>
    <nav>
      <a href="/" id="logo">~<span id="logo-full">Mehdi</span></a>
      <div id="menu">
        <a href="/posts/">Posts</a>
      </div>
    </nav>
  </header>
  <section class="section">
    <div class="container">
      

<div class="toc">
  <ul>
    
    <li>
      <a href="https://mehdibenhadjkhelifa.github.io/posts/syzbot-bug/#why-a-memory-leak-bug">Why a memory leak bug?</a>
      
    </li>
    
    <li>
      <a href="https://mehdibenhadjkhelifa.github.io/posts/syzbot-bug/#first-steps-to-fixing-a-bug">First steps to fixing a bug</a>
      
    </li>
    
    <li>
      <a href="https://mehdibenhadjkhelifa.github.io/posts/syzbot-bug/#our-case-study">Our case study</a>
      
      <ul>
        
        <li>
          <a href="https://mehdibenhadjkhelifa.github.io/posts/syzbot-bug/#reproducing-the-bug-examining-the-crash">Reproducing the bug &amp;&amp; examining the crash</a>
        </li>
        
        <li>
          <a href="https://mehdibenhadjkhelifa.github.io/posts/syzbot-bug/#initial-code-investigation">Initial code investigation</a>
        </li>
        
        <li>
          <a href="https://mehdibenhadjkhelifa.github.io/posts/syzbot-bug/#using-gdb-to-demystify-the-cause-of-the-bug">Using gdb to demystify the cause of the bug</a>
        </li>
        
        <li>
          <a href="https://mehdibenhadjkhelifa.github.io/posts/syzbot-bug/#attempting-a-fix">Attempting a fix</a>
        </li>
        
        <li>
          <a href="https://mehdibenhadjkhelifa.github.io/posts/syzbot-bug/#why-is-it-a-mistake-the-actual-fix">Why is it a mistake &amp;&amp; the actual fix</a>
        </li>
        
      </ul>
      
    </li>
    
    <li>
      <a href="https://mehdibenhadjkhelifa.github.io/posts/syzbot-bug/#closing-remarks-suggestions-for-future-mentees">Closing remarks &amp;&amp; suggestions for future mentees</a>
      
    </li>
    
  </ul>
</div>

<main>
  <h1 class="title">
    How I solved a linux kernel memory leak bug
  </h1>
  <p class="dateline subtitle">2025-12-09</p>
  <p>As part of my <a href="https://mehdibenhadjkhelifa.github.io/posts/kernel-mentorship">linux kernel mentorship program</a>, We have to try and solve bugs reported by <span class="sidenote-ref">syzbot<span class="sidenote-number"><small class="sidenote"><!--&#8203;-->&nbsp;<span class="sidenote-surroundings">&nbsp;(</span>syzbot is an automated fuzzing system that is one way of getting linux kernel bugs reported to the linux kernel community to fix<span class="sidenote-surroundings">)&nbsp;</span></small></span></span>
which is no easy feat for some unfamiliar folks that are just getting started to hack their ways into the kernel like myself. Nonetheless, that didn’t stop me from trying as many bugs <span class="sidenote-ref">that didn’t feel out of reach for me<span class="sidenote-number"><small class="sidenote"><!--&#8203;-->&nbsp;<span class="sidenote-surroundings">&nbsp;(</span>mainly avoided kernel bugs that touch the core of any subsystem since those are for more experts of said subsystem which are more trusted by the maintainers to fix those issues.<span class="sidenote-surroundings">)&nbsp;</span></small></span></span>
 as I can.</p>
<h2 id="why-a-memory-leak-bug"><a class="zola-anchor" href="#why-a-memory-leak-bug" aria-label="Anchor link for: why-a-memory-leak-bug">Why a memory leak bug?</a></h2>
<p>Syzbot has many types of bugs that it reports. To note a few, it can report bugs triggered by the <code>BUG()</code> and <code>WARN()</code> family of macros used across the kernel,slab-use-after-free using the <span class="sidenote-ref">KASAN<span class="sidenote-number"><small class="sidenote"><!--&#8203;-->&nbsp;<span class="sidenote-surroundings">&nbsp;(</span>Kernel Address Sanitizer<span class="sidenote-surroundings">)&nbsp;</span></small></span></span>
, uninit values using the <span class="sidenote-ref">KMSAN<span class="sidenote-number"><small class="sidenote"><!--&#8203;-->&nbsp;<span class="sidenote-surroundings">&nbsp;(</span>Kernel Memory Sanitizer<span class="sidenote-surroundings">)&nbsp;</span></small></span></span>
, memory leaks with Kmemleak and many more. In the limited time that I had during the mentorship, I have attempted many types of bugs to try and deduce a pattern. Spoiler, there are no patterns (almost).But there is a <span class="sidenote-ref">degree of difficulty for each type<span class="sidenote-number"><small class="sidenote"><!--&#8203;-->&nbsp;<span class="sidenote-surroundings">&nbsp;(</span>of course it also depends on the specific bug but this is a more of a generalized view<span class="sidenote-surroundings">)&nbsp;</span></small></span></span>
. From my little experience around those bugs and for the available skills that I have, I found that memory leaks and KMSAN bugs are usually easier than other bugs given that you are very comfortable with gdb and that’s mainly because concurrency isn’t the cause of said bug most of the time or at least for most of the ones that I have attempted.For those reasons I have attempted memory leak and KMSAN bugs more than others after the initial phase of exploration.</p>
<h2 id="first-steps-to-fixing-a-bug"><a class="zola-anchor" href="#first-steps-to-fixing-a-bug" aria-label="Anchor link for: first-steps-to-fixing-a-bug">First steps to fixing a bug</a></h2>
<p>First, you should choose a bug of a subsystem that you are most familiar with. If you have no familiarity with no subsystem, I highly recommend trying to contribute to the selftests of such subsystem, read some documentation or <span class="sidenote-ref">read a relative book to that subsystem<span class="sidenote-number"><small class="sidenote"><!--&#8203;-->&nbsp;<span class="sidenote-surroundings">&nbsp;(</span>In the context of kernel development, reading books is just good to give you a history or a more generalized view of the code base.Since the kernel is always updating and changing, it’s hard for books keep being update to date for what is currently available in the source code.<span class="sidenote-surroundings">)&nbsp;</span></small></span></span>
if it isn’t a highly updated one and then try to fix a related bug to that subsystem.This isn’t a rule but it really helps and makes it easier to navigate and understand some of the moving parts at least those that are around the bug that you are trying to solve.
Second, you need to be able to reproduced your chosen bug locally. If you don’t have the hardware or for one reason or another , using the syz/C reproducers didn’t trigger the bug, you should <span class="sidenote-ref">abort working on a fix said bug<span class="sidenote-number"><small class="sidenote"><!--&#8203;-->&nbsp;<span class="sidenote-surroundings">&nbsp;(</span>Here I’m only talking about us fellow mentees and beginners. Other experienced contributors and experts of a subsystem might attempt to fix a bug without a reproducer and have their fix tested for them.<span class="sidenote-surroundings">)&nbsp;</span></small></span></span>
.
Finally, Try to look at other similar bugs that are of same type for the same subsystem which are fixed. Read the related email, the patch and the discussion between maintainers and the author of the patch. That also is a really good way to help you have an idea of how to approach your bug and maybe on how to also fix it. </p>
<h2 id="our-case-study"><a class="zola-anchor" href="#our-case-study" aria-label="Anchor link for: our-case-study">Our case study</a></h2>
<p>The syzbot bug in question here is the <a href="https://syzkaller.appspot.com/bug?extid=ad45f827c88778ff7df6"><code>memory leak in hfs_init_fs_context</code></a>. Since as I mentionned in <a href="https://mehdibenhadjkhelifa.github.io/posts/kernel-mentorship">my mentorship post</a>, I have read the OSTEP book which gave me a general idea of how filesystems work. So naturally, most of my syzbot bug attempts were in the mm and fs subsystems. Previous attempts have failed mainly due to someone else submitting a fix before I can quickly craft one myself due to my lack of experience.</p>
<h3 id="reproducing-the-bug-examining-the-crash"><a class="zola-anchor" href="#reproducing-the-bug-examining-the-crash" aria-label="Anchor link for: reproducing-the-bug-examining-the-crash">Reproducing the bug &amp;&amp; examining the crash</a></h3>
<p>At the start of my mentorship, I have <a href="https://www.youtube.com/watch?v=W5ZRkI_fGv0&amp;t=3621s">live streamed</a> my initial phases of setting up syzkaller locally and trying to reproduce a bug following <a href="https://www.linkedin.com/pulse/proof-execution-reproducing-syzbot-bugs-local-kernel-moon-hee-lee-081bc/">an older mentee’s linkedin post</a>.You can look at that to see how to do that if you are unfamiliar. So using QEMU to run the provided kernel from the syzbot bug and running the reproducer, I get the exact crash as the one reported by syzbot. Same results also from running the reproducer on a built kernel using the .config file provided from the syzbot bug page. Let’s look at the relevant parts of the crash with the decoded stack trace:</p>
<pre class="z-code"><code><span class="z-text z-plain">[   97.750949][ T5859] kmemleak: 1 new suspected memory leaks (see /sys/kernel/debug/kmemleak)
[  103.909124][ T5859] kmemleak: 1 new suspected memory leaks (see /sys/kernel/debug/kmemleak)
BUG: memory leak
<mark>unreferenced object 0xffff888111778c00 (size 512):
</mark>  comm &quot;syz.0.17&quot;, pid 6092, jiffies 4294942644
  hex dump (first 32 bytes):
    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
  backtrace (crc eb1d7412):
    kmemleak_alloc_recursive include/linux/kmemleak.h:44 [inline]
    slab_post_alloc_hook [mm/slub.c:4979] [inline]
    slab_alloc_node [mm/slub.c:5284 [inline]
    __kmalloc_cache_noprof+0x3a6/0x5b0 [mm/slub.c:5762]
    kmalloc_noprof [include/linux/slab.h:957] [inline]
    kzalloc_noprof [include/linux/slab.h:1094] [inline]
<mark>    hfs_init_fs_context+0x24/0xd0 [fs/hfs/super.c:411]
</mark><mark>    alloc_fs_context+0x214/0x430 [fs/fs_context.c:315]
</mark><mark>    do_new_mount [fs/namespace.c:3707] [inline]
</mark><mark>    path_mount+0x93c/0x12e0 [fs/namespace.c:4037]
</mark><mark>    do_mount [fs/namespace.c:4050] [inline]
</mark>    __do_sys_mount [fs/namespace.c:4238] [inline]
    __se_sys_mount [fs/namespace.c:4215] [inline]
    __x64_sys_mount+0x1a2/0x1e0 [fs/namespace.c:4215]
    do_syscall_x64 [arch/x86/entry/syscall_64.c:63] [inline]
    do_syscall_64+0xa4/0xfa0 [arch/x86/entry/syscall_64.c:94]
    entry_SYSCALL_64_after_hwframe+0x77/0x7f
</span></code></pre>
<p>The first highlighted line indicate that the size of such memory leak is of 512 bytes and the following highlighted lines indicate that this buffer of memory is allocated upon doing a mounting of an hfs type filesystem and more specifically in initializing the filesystem context in <code>hfs/super.c</code> line 411. </p>
<h3 id="initial-code-investigation"><a class="zola-anchor" href="#initial-code-investigation" aria-label="Anchor link for: initial-code-investigation">Initial code investigation</a></h3>
<p>Based on the indicators mentionned in the crash report, let’s have a look at the surrounding code in <code>hfs/super.c</code> first.
<small class="sidenote marginnote">&#8203;<span class="sidenote-surroundings">&nbsp;(</span><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/hfs/super.c?id=4ea7c1717f3f2344f7a1cdab4f5875cfa89c87a9#n411"><code>fs/hfs/super.c:411</code></a><span class="sidenote-surroundings">)&nbsp;</span></small></p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-storage z-modifier z-c">static</span> <span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">hfs_init_fs_context</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">struct</span> fs_context <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">fc</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
	<span class="z-storage z-type z-c">struct</span> hfs_sb_info <span class="z-keyword z-operator z-c">*</span>hsb<span class="z-punctuation z-terminator z-c">;</span>

<mark>	hsb <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">kzalloc</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-keyword z-operator z-word z-c">sizeof</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">struct</span> hfs_sb_info</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-separator z-c">,</span> GFP_KERNEL</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</mark>	<span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-keyword z-operator z-arithmetic z-c">!</span>hsb<span class="z-punctuation z-section z-group z-end z-c">)</span></span>
		<span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-keyword z-operator z-arithmetic z-c">-</span>ENOMEM<span class="z-punctuation z-terminator z-c">;</span>

<mark>	fc<span class="z-punctuation z-accessor z-c">-&gt;</span>s_fs_info <span class="z-keyword z-operator z-assignment z-c">=</span> hsb<span class="z-punctuation z-terminator z-c">;</span>
</mark>	fc<span class="z-punctuation z-accessor z-c">-&gt;</span>ops <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-keyword z-operator z-c">&amp;</span>hfs_context_ops<span class="z-punctuation z-terminator z-c">;</span>

	<span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>fc<span class="z-punctuation z-accessor z-c">-&gt;</span>purpose <span class="z-keyword z-operator z-comparison z-c">!=</span> FS_CONTEXT_FOR_RECONFIGURE<span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
		<span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> initialize options with defaults <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
		hsb<span class="z-punctuation z-accessor z-c">-&gt;</span>s_uid <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">current_uid</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
		hsb<span class="z-punctuation z-accessor z-c">-&gt;</span>s_gid <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">current_gid</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
		hsb<span class="z-punctuation z-accessor z-c">-&gt;</span>s_file_umask <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-octal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0</span>133</span><span class="z-punctuation z-terminator z-c">;</span>
		hsb<span class="z-punctuation z-accessor z-c">-&gt;</span>s_dir_umask <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-octal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0</span>022</span><span class="z-punctuation z-terminator z-c">;</span>
		hsb<span class="z-punctuation z-accessor z-c">-&gt;</span>s_type <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">cpu_to_be32</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>3f3f3f3f</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> == &#39;????&#39; <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
		hsb<span class="z-punctuation z-accessor z-c">-&gt;</span>s_creator <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">cpu_to_be32</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>3f3f3f3f</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> == &#39;????&#39; <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
		hsb<span class="z-punctuation z-accessor z-c">-&gt;</span>s_quiet <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span>
		hsb<span class="z-punctuation z-accessor z-c">-&gt;</span>part <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-keyword z-operator z-arithmetic z-c">-</span><span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-terminator z-c">;</span>
		hsb<span class="z-punctuation z-accessor z-c">-&gt;</span>session <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-keyword z-operator z-arithmetic z-c">-</span><span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-terminator z-c">;</span>
	<span class="z-punctuation z-section z-block z-end z-c">}</span></span>

	<span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<p>We can see that the leaked memory is a <code>hfs_sb_info</code> struct allocated on the first highlighted line which is also the 411 line mentionned in the report and <span class="sidenote-ref">is of 512 bytes<span class="sidenote-number"><small class="sidenote"><!--&#8203;-->&nbsp;<span class="sidenote-surroundings">&nbsp;(</span>I manually checked <code>sizeof(struct hfs_sb_info)</code><span class="sidenote-surroundings">)&nbsp;</span></small></span></span>
. Also we notice that the ownership of the pointer to the allocated memory buffer for that struct is transfered to the filesystem context struct.The function responsible for cleaning up the hfs context is the <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/hfs/super.c?id=4ea7c1717f3f2344f7a1cdab4f5875cfa89c87a9#n395"><code>hfs_free_fc()</code></a> So my initial thoughts here were, would it be that the error path that is being fuzzed didn’t include a call to the cleanup function? Here we needed some gdb digging.</p>
<h3 id="using-gdb-to-demystify-the-cause-of-the-bug"><a class="zola-anchor" href="#using-gdb-to-demystify-the-cause-of-the-bug" aria-label="Anchor link for: using-gdb-to-demystify-the-cause-of-the-bug">Using gdb to demystify the cause of the bug</a></h3>
<p>First I setup a breakpoint at <code>hfs_free_fc()</code> to check if it’s being called or not and it indeed was being called. The issue though becomes clearer as the pointer <code>fc-&gt;s_fs_info</code> is <code>NULL</code>.
This means that the ownership of said pointer has been moved again or was assigned <code>NULL</code> before it’s actual cleanup. My next step is to find out where exactly was the <code>fc-&gt;s_fs_info</code> been assigned to <code>NULL</code>. Consequently, I setup a breakpoint within the <code>hfs_init_fs_context()</code> to follow the calls that succeed  it while always inspecting the memory/value of <code>fc-&gt;s_fs_info</code> to check where it gets <code>NULL</code>. Doing so, I got to the function <code>sget_fc()</code> that does the transfer of ownership and setting <code>fc-&gt;s_fs_info</code> to <code>NULL</code>.The following is the related call stack(simplified) and the mentionned code.</p>
<pre data-lang="crash" class="language-crash z-code"><code class="language-crash" data-lang="crash"><span class="z-text z-plain">sget_fc [fs/super.c:733]
sget_bdev [fs/super.c:1405]
get_tree_bdev_flags [fs/super.c:1677]
vfs_get_tree [fs/super.c:1751]
fc_mount [fs/namespace.c:1208]
do_new_mount_fc [fs/namespace.c:3651]
do_new_mount [fs/namespace.c:3727]
path_mount [fs/namespace.c:4037]
do_mount [fs/namespace.c:4050]
....
</span></code></pre>
<small class="sidenote marginnote">&#8203;<span class="sidenote-surroundings">&nbsp;(</span><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/super.c?id=4ea7c1717f3f2344f7a1cdab4f5875cfa89c87a9#n774"><code>fs/super.c:774</code></a><span class="sidenote-surroundings">)&nbsp;</span></small><pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-storage z-type z-c">struct</span> super_block <span class="z-keyword z-operator z-c">*</span><span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">sget_fc</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">struct</span> fs_context <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">fc</span><span class="z-punctuation z-separator z-c">,</span>
			    <span class="z-storage z-type z-c">int</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-keyword z-operator z-c">*</span>test<span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-storage z-type z-c">struct</span> super_block <span class="z-keyword z-operator z-c">*</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">struct</span> fs_context <span class="z-keyword z-operator z-c">*</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-separator z-c">,</span>
			    <span class="z-storage z-type z-c">int</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-keyword z-operator z-c">*</span>set<span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-storage z-type z-c">struct</span> super_block <span class="z-keyword z-operator z-c">*</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">struct</span> fs_context <span class="z-keyword z-operator z-c">*</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
	<span class="z-storage z-type z-c">struct</span> super_block <span class="z-keyword z-operator z-c">*</span>s <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-language z-c">NULL</span><span class="z-punctuation z-terminator z-c">;</span>
	<span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> snip <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
<mark>	s<span class="z-punctuation z-accessor z-c">-&gt;</span>s_fs_info <span class="z-keyword z-operator z-assignment z-c">=</span> fc<span class="z-punctuation z-accessor z-c">-&gt;</span>s_fs_info<span class="z-punctuation z-terminator z-c">;</span>
</mark>	err <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">set</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">s<span class="z-punctuation z-separator z-c">,</span> fc</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
	<span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>err<span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
		s<span class="z-punctuation z-accessor z-c">-&gt;</span>s_fs_info <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-language z-c">NULL</span><span class="z-punctuation z-terminator z-c">;</span>
		<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">spin_unlock</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-keyword z-operator z-c">&amp;</span>sb_lock</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
		<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">destroy_unused_super</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">s</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
		<span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">ERR_PTR</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">err</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
	<span class="z-punctuation z-section z-block z-end z-c">}</span></span>
<mark>	fc<span class="z-punctuation z-accessor z-c">-&gt;</span>s_fs_info <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-language z-c">NULL</span><span class="z-punctuation z-terminator z-c">;</span>
</mark>	s<span class="z-punctuation z-accessor z-c">-&gt;</span>s_type <span class="z-keyword z-operator z-assignment z-c">=</span> fc<span class="z-punctuation z-accessor z-c">-&gt;</span>fs_type<span class="z-punctuation z-terminator z-c">;</span>
	s<span class="z-punctuation z-accessor z-c">-&gt;</span>s_iflags <span class="z-keyword z-operator z-assignment z-augmented z-c">|=</span> fc<span class="z-punctuation z-accessor z-c">-&gt;</span>s_iflags<span class="z-punctuation z-terminator z-c">;</span>
	<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">strscpy</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">s<span class="z-punctuation z-accessor z-c">-&gt;</span>s_id<span class="z-punctuation z-separator z-c">,</span> s<span class="z-punctuation z-accessor z-c">-&gt;</span>s_type<span class="z-punctuation z-accessor z-c">-&gt;</span>name<span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-word z-c">sizeof</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span><span class="z-meta z-group z-c">s<span class="z-punctuation z-accessor z-c">-&gt;</span>s_id</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
	<span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> snip <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<p>At this point,I have already seen that <code>vfs_get_tree()</code> in the call stack was returning an error from earlier attempts and that the error propagation starts from the <code>get_tree_bdev_flags()</code> function. So I needed to follow the flow of execution in that function after the allocation of a new superblock in <code>sget_fc()</code> to see exactly what function caused the error and how it was handled. 
<small class="sidenote marginnote">&#8203;<span class="sidenote-surroundings">&nbsp;(</span><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/super.c?id=4ea7c1717f3f2344f7a1cdab4f5875cfa89c87a9#n1659"><code>fs/super.c:1659</code></a><span class="sidenote-surroundings">)&nbsp;</span></small></p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">get_tree_bdev_flags</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">struct</span> fs_context <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">fc</span><span class="z-punctuation z-separator z-c">,</span>
		<span class="z-storage z-type z-c">int</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-keyword z-operator z-c">*</span>fill_super<span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-storage z-type z-c">struct</span> super_block <span class="z-keyword z-operator z-c">*</span>sb<span class="z-punctuation z-separator z-c">,</span>
				  <span class="z-storage z-type z-c">struct</span> fs_context <span class="z-keyword z-operator z-c">*</span>fc<span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">unsigned</span> <span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c">flags</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
	<span class="z-storage z-type z-c">struct</span> super_block <span class="z-keyword z-operator z-c">*</span>s<span class="z-punctuation z-terminator z-c">;</span>
	<span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> snip <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
	<span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>s<span class="z-punctuation z-accessor z-c">-&gt;</span>s_root<span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
		<span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Don&#39;t summarily change the RO/RW state. <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
		<span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>fc<span class="z-punctuation z-accessor z-c">-&gt;</span>sb_flags <span class="z-keyword z-operator z-arithmetic z-c">^</span> s<span class="z-punctuation z-accessor z-c">-&gt;</span>s_flags<span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-c">&amp;</span> SB_RDONLY<span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
			<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">warnf</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">fc<span class="z-punctuation z-separator z-c">,</span> <span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span><span class="z-constant z-other z-placeholder z-c">%p</span>g: Can&#39;t mount, would change RO state<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-punctuation z-separator z-c">,</span> s<span class="z-punctuation z-accessor z-c">-&gt;</span>s_bdev</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
			<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">deactivate_locked_super</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">s</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
			<span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-keyword z-operator z-arithmetic z-c">-</span>EBUSY<span class="z-punctuation z-terminator z-c">;</span>
		<span class="z-punctuation z-section z-block z-end z-c">}</span></span>
	<span class="z-punctuation z-section z-block z-end z-c">}</span></span> <span class="z-keyword z-control z-c">else</span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
<mark>		error <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">setup_bdev_super</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">s<span class="z-punctuation z-separator z-c">,</span> fc<span class="z-punctuation z-accessor z-c">-&gt;</span>sb_flags<span class="z-punctuation z-separator z-c">,</span> fc</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</mark>		<span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-keyword z-operator z-arithmetic z-c">!</span>error<span class="z-punctuation z-section z-group z-end z-c">)</span></span>
<mark>			error <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">fill_super</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">s<span class="z-punctuation z-separator z-c">,</span> fc</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</mark>		<span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>error<span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
<mark>			<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">deactivate_locked_super</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">s</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</mark>			<span class="z-keyword z-control z-flow z-return z-c">return</span> error<span class="z-punctuation z-terminator z-c">;</span>
		<span class="z-punctuation z-section z-block z-end z-c">}</span></span>
		s<span class="z-punctuation z-accessor z-c">-&gt;</span>s_flags <span class="z-keyword z-operator z-assignment z-augmented z-c">|=</span> SB_ACTIVE<span class="z-punctuation z-terminator z-c">;</span>
	<span class="z-punctuation z-section z-block z-end z-c">}</span></span>
	<span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> snip <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<p><code>setup_bdev_super()</code> as highlighted here is the function inside <code>get_tree_bdev_flags()</code> which <span class="sidenote-ref">returns an error<span class="sidenote-number"><small class="sidenote"><!--&#8203;-->&nbsp;<span class="sidenote-surroundings">&nbsp;(</span>Other calls that caused the error in the <code>setup_bdev_super()</code> function were skipped since most of them either propagate the error or cleanup related structures to the block device.And so the more reasonable fix for this bug would either be at the <code>get_tree_bdev_flags()</code> level or above.<span class="sidenote-surroundings">)&nbsp;</span></small></span></span>
.So I jumped to <code>deactivate_locked_super()</code> which should handle such error and found that it does call the fs-specific function of killing a superblock, but in the case of the <code>HFS</code>, the function pointer is assigned to a generic shutdown function which doesn’t handle the freeing of the superblock struct. Below is the mentionned code.
<small class="sidenote marginnote">&#8203;<span class="sidenote-surroundings">&nbsp;(</span><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/super.c?id=4ea7c1717f3f2344f7a1cdab4f5875cfa89c87a9#n468"><code>fs/super.c:468</code></a><span class="sidenote-surroundings">)&nbsp;</span></small></p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-storage z-type z-c">void</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">deactivate_locked_super</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">struct</span> super_block <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">s</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
	<span class="z-storage z-type z-c">struct</span> file_system_type <span class="z-keyword z-operator z-c">*</span>fs <span class="z-keyword z-operator z-assignment z-c">=</span> s<span class="z-punctuation z-accessor z-c">-&gt;</span>s_type<span class="z-punctuation z-terminator z-c">;</span>
	<span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">atomic_dec_and_test</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-keyword z-operator z-c">&amp;</span>s<span class="z-punctuation z-accessor z-c">-&gt;</span>s_active</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
		<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">shrinker_free</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">s<span class="z-punctuation z-accessor z-c">-&gt;</span>s_shrink</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
<mark>		fs<span class="z-punctuation z-accessor z-c">-&gt;</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">kill_sb</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">s</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</mark>
		<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">kill_super_notify</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">s</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>

		<span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span>
		 <span class="z-punctuation z-definition z-comment z-c">*</span> Since list_lru_destroy() may sleep, we cannot call it from
		 <span class="z-punctuation z-definition z-comment z-c">*</span> put_super(), where we hold the sb_lock. Therefore we destroy
		 <span class="z-punctuation z-definition z-comment z-c">*</span> the lru lists right now.
		 <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
		<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">list_lru_destroy</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-keyword z-operator z-c">&amp;</span>s<span class="z-punctuation z-accessor z-c">-&gt;</span>s_dentry_lru</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
		<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">list_lru_destroy</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-keyword z-operator z-c">&amp;</span>s<span class="z-punctuation z-accessor z-c">-&gt;</span>s_inode_lru</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>

		<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">put_filesystem</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">fs</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
		<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">put_super</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">s</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
	<span class="z-punctuation z-section z-block z-end z-c">}</span></span> <span class="z-keyword z-control z-c">else</span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
		<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">super_unlock_excl</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">s</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
	<span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<small class="sidenote marginnote">&#8203;<span class="sidenote-surroundings">&nbsp;(</span><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/hfs/super.c?id=4ea7c1717f3f2344f7a1cdab4f5875cfa89c87a9#n434"><code>fs/hfs/super.c:434</code></a><span class="sidenote-surroundings">)&nbsp;</span></small><pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-storage z-modifier z-c">static</span> <span class="z-storage z-type z-c">struct</span> file_system_type hfs_fs_type <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
	<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">owner</span>		<span class="z-keyword z-operator z-assignment z-c">=</span> THIS_MODULE<span class="z-punctuation z-separator z-c">,</span>
	<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">name</span>		<span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>hfs<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-punctuation z-separator z-c">,</span>
<mark>	<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">kill_sb</span>	<span class="z-keyword z-operator z-assignment z-c">=</span> kill_block_super<span class="z-punctuation z-separator z-c">,</span>
</mark>	<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">fs_flags</span>	<span class="z-keyword z-operator z-assignment z-c">=</span> FS_REQUIRES_DEV<span class="z-punctuation z-separator z-c">,</span>
	<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">init_fs_context</span> <span class="z-keyword z-operator z-assignment z-c">=</span> hfs_init_fs_context<span class="z-punctuation z-separator z-c">,</span>
<span class="z-punctuation z-section z-block z-end z-c">}</span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></code></pre>
<small class="sidenote marginnote">&#8203;<span class="sidenote-surroundings">&nbsp;(</span><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/super.c?id=4ea7c1717f3f2344f7a1cdab4f5875cfa89c87a9#n1718"><code>fs/super.c:1718</code></a><span class="sidenote-surroundings">)&nbsp;</span></small><pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-storage z-type z-c">void</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">kill_block_super</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">struct</span> super_block <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">sb</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
	<span class="z-storage z-type z-c">struct</span> block_device <span class="z-keyword z-operator z-c">*</span>bdev <span class="z-keyword z-operator z-assignment z-c">=</span> sb<span class="z-punctuation z-accessor z-c">-&gt;</span>s_bdev<span class="z-punctuation z-terminator z-c">;</span>

	<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">generic_shutdown_super</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">sb</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
	<span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>bdev<span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
		<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">sync_blockdev</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">bdev</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
		<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">bdev_fput</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">sb<span class="z-punctuation z-accessor z-c">-&gt;</span>s_bdev_file</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
	<span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>

</span></code></pre>
<h3 id="attempting-a-fix"><a class="zola-anchor" href="#attempting-a-fix" aria-label="Anchor link for: attempting-a-fix">Attempting a fix</a></h3>
<p>Here is where I made my first not technical but logical mistake. I assumed that since <code>hfs_free_fc()</code> was being called with a <span class="sidenote-ref"><code>NULL</code><span class="sidenote-number"><small class="sidenote"><!--&#8203;-->&nbsp;<span class="sidenote-surroundings">&nbsp;(</span>important to note here that the <code>hfs_free_fc()</code> didn’t have any checks for <code>fc-&gt;s_fs_info</code> being <code>NULL</code> and was calling <code>kfree()</code> on it<span class="sidenote-surroundings">)&nbsp;</span></small></span></span>
 from a higher calling function (<code>do_new_mount()</code>), the suitable fix here was to return the ownership of the <code>s_fs_info</code>  from the super block to the filesystem context just above the <code>deactivate_locker_super()</code> function so that it will to be freed.I also took into consideration that other filesystems can have the same issue here and so by doing this at a core level would also be fixing it for any other filesystem that would’ve suffered from the same bug.</p>
<h3 id="why-is-it-a-mistake-the-actual-fix"><a class="zola-anchor" href="#why-is-it-a-mistake-the-actual-fix" aria-label="Anchor link for: why-is-it-a-mistake-the-actual-fix">Why is it a mistake &amp;&amp; the actual fix</a></h3>
<p>This fix did indeed fix this specific bug and the reproducer generated no more errors,it was <a href="https://lore.kernel.org/all/20251118165553.GF2441659@ZenIV/">pointed out to me by maintainers quickly</a> that this approach was a mistake. They have clarified that once the ownership is moved, <a href="https://lore.kernel.org/all/20251118163509.GE2441659@ZenIV/">it cannot be returned</a> . And that <code>fill_super()</code> for each filesystem is the one responsible for freeing such struct which I then clarrified that in this error path, it isn’t even called. So the more logical route that they have recommended to make a fix was to instead write a function that handles the freeing of the super block struct + have the generic shutdown of the super block function being called and then assign it’s function pointer to <code>kill_sb</code> which is called to kill the super block for each specific filesystem. On top of that,other functions handling that freeing of memory was removed since <code>kill_sb</code> is always called to cleanup. So after iteration and discussion with maintainers, We have come up with a <a href="https://lore.kernel.org/all/20251201222843.82310-2-mehdi.benhadjkhelifa@gmail.com/">patch</a> that has been reviewed and is waiting to be merged in at the time of writing this post.</p>
<h2 id="closing-remarks-suggestions-for-future-mentees"><a class="zola-anchor" href="#closing-remarks-suggestions-for-future-mentees" aria-label="Anchor link for: closing-remarks-suggestions-for-future-mentees">Closing remarks &amp;&amp; suggestions for future mentees</a></h2>
<p><a href="https://lore.kernel.org/all/8727342f9a168c7e8008178e165a5a14fa7f470d.camel@ibm.com/">Discussion</a> with maintainers has led to the suspicion that other filesystems could also be affected with the same bug and I have already worked with the maintainer of HFS and HFS+ on a similar <a href="https://lore.kernel.org/all/20251201222843.82310-3-mehdi.benhadjkhelifa@gmail.com/">patch</a> for HFS+. Fixing this bug in other filesystems will be my avenue of contributions for the following release cycles.</p>
<p>Furthermore, These patches have been run through religious testing by me and the maintainer of <code>HFS/HFS+</code> using many tools including xfstests,selftests,… which is a must for any bug fix before sending it.</p>
<p>My advice for any mentee that is working on a syzbot bug is to:</p>
<ol>
<li><strong>Work on an actual fix, Not a suppression of the bug</strong>: this might be obvious but I noticed that some of my fellow mentees do this and have been pushed back for it. Not only does it hurt your reputation in the linux kernel community, but it also shows that you either don’t grasp the impact of having such changes in the kernel or that you don’t understand what you are doing. So avoid propagating the error and not handling it, removing the bug triggers such as <code>BUG()</code> or <code>WARN()</code> or any other simple suppressing methods.</li>
<li><strong>Fixing with intention</strong>: Having an idea of the cause and pin pointing the issue to a degree of accuracy is highly recommended to get the attention of maintainers to help you get to the actual fix. If you are just throwing bluff and hoping for help or a fix, you will be ignored.</li>
<li><strong>Testing is most important</strong> : Having worked on a fix, You should not <em>only</em> test with the reproducer that triggers the bug. This relates to my first point too. After seeing that the bug no longer triggers with the reproducer and you are confident of the fix. Run any suitable tests that you can. This includes selftests, specific subsystem tests that are separate from the mainline tree, making a module yourself and doing a fault injection check and any other things that makes you more sure of the robustness of your change. This will highly affect how your patch will be treated by the linux community and if it is even worth to be looked at since lack of testing results in a lack of trust. And such testing is expect from contributors and assumed by maintainers.</li>
</ol>
<p>I hope that at least some people and some future mentees benefited from this bug walkthrough and  I would like to thank my mentors <a href="https://www.linkedin.com/in/shuah-khan/">shuah</a>,<a href="https://www.linkedin.com/in/david-hunter-34a10371/">david</a> and <a href="https://www.linkedin.com/in/khalidaziz/">khalid</a> for their guidance,the welcoming linux kernel community and maintainers for their help.</p>
<p>Without this support, kickstarting such bug huntings would have been much harder.</p>
<p><em>Happy hacking everyone!</em></p>

</main>

<script src="/js/scrollsync.js"></script>

    </div>
  </section>
</body>

</html>
